<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COFFEEMANIA - –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</title>
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="2.0.0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0F0C29">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="COFFEEMANIA">
    <meta name="description" content="–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∫–æ—Ñ–µ–π–Ω–∏ COFFEEMANIA - –∫–∞–∂–¥–∞—è 7-—è —á–∞—à–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="" id="manifest-link">
    
    <!-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç –°–†–ê–ó–£ -->
    <script>
        // –ö–†–ò–¢–ò–ß–ù–û: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç –ù–ï–ú–ï–î–õ–ï–ù–ù–û
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('id');
            const manifestLink = document.getElementById('manifest-link');
            
            if (clientId && manifestLink) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                manifestLink.href = `/manifest-${clientId}.json`;
                console.log(`üì± PWA –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞: ${clientId}`);
                
                // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤ localStorage –¥–ª—è PWA
                localStorage.setItem('coffeemania_customer_id', clientId);
            } else {
                // Fallback –Ω–∞ –æ–±—â–∏–π –º–∞–Ω–∏—Ñ–µ—Å—Ç
                if (manifestLink) {
                    manifestLink.href = '/manifest.json';
                }
                console.log('üì± –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ–±—â–∏–π –º–∞–Ω–∏—Ñ–µ—Å—Ç (fallback)');
            }
        })();
    </script>
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Modern Color Palette */
            --bg-primary: linear-gradient(135deg, #0F0C29 0%, #24243e 25%, #302b63 50%, #8B4513 75%, #DAA520 100%);
            --bg-secondary: rgba(255, 255, 255, 0.08);
            --bg-glass: rgba(255, 255, 255, 0.12);
            --bg-glass-hover: rgba(255, 255, 255, 0.18);
            --bg-card: rgba(255, 255, 255, 0.1);
            --bg-input: rgba(255, 255, 255, 0.05);
            
            /* Text Colors */
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-muted: rgba(255, 255, 255, 0.6);
            
            /* Accent Colors */
            --accent-orange: #FF6B35;
            --accent-green: #00D4AA;
            --accent-red: #FF4757;
            --accent-yellow: #FFA502;
            --accent-blue: #3742FA;
            --accent-gold: #DAA520;
            
            /* Effects */
            --border-glass: rgba(255, 255, 255, 0.2);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.4);
            --blur: blur(20px);
            --border-radius: 20px;
            --border-radius-small: 12px;
            
            /* Gradients */
            --gradient-orange: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            --gradient-green: linear-gradient(135deg, #00D4AA 0%, #00B894 100%);
            --gradient-red: linear-gradient(135deg, #FF4757 0%, #FF3742 100%);
            --gradient-blue: linear-gradient(135deg, #3742FA 0%, #2F3A8F 100%);
            --gradient-gold: linear-gradient(135deg, #DAA520 0%, #B8860B 100%);
            --gradient-coffee: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #DAA520 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(218, 165, 32, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(0, 212, 170, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-top: 40px;
        }
        
        .greeting {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .customer-name {
            color: var(--text-primary);
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .current-date {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Main Card */
        .main-card {
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            padding: 32px 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow-glass);
            position: relative;
            overflow: hidden;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .main-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }
        
        .main-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-gold);
        }
        
        /* Coffee Illustration */
        .coffee-illustration {
            width: 100%;
            height: 200px;
            border-radius: 16px;
            background: var(--gradient-coffee);
            position: relative;
            margin-bottom: 24px;
            overflow: hidden;
            box-shadow: 0 16px 32px rgba(139, 69, 19, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            transition: all 0.3s ease;
        }
        
        .coffee-illustration:hover {
            transform: scale(1.02);
            box-shadow: 0 20px 40px rgba(139, 69, 19, 0.4);
        }
        
        .coffee-illustration::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 40%, rgba(139, 69, 19, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(218, 165, 32, 0.2) 0%, transparent 40%);
            pointer-events: none;
        }
        
        /* Brand Section */
        .brand-section {
            margin-bottom: 32px;
        }
        
        .brand-title {
            font-size: 28px;
            font-weight: 800;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .brand-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
        }
        
        /* Progress Section */
        .progress-section {
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow-glass);
            transition: all 0.3s ease;
        }
        
        .progress-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .progress-title {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .progress-text {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .coffee-dots {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .coffee-dot {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid var(--border-glass);
            position: relative;
            overflow: hidden;
        }
        
        .coffee-dot.filled {
            background: var(--gradient-orange);
            color: white;
            border-color: var(--accent-orange);
            box-shadow: 0 8px 16px rgba(255, 107, 53, 0.3);
            animation: fillPop 0.5s ease-out;
        }
        
        .coffee-dot.filled::after {
            content: '‚úì';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: var(--gradient-green);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .coffee-dot.empty {
            background: var(--bg-input);
            color: var(--text-muted);
            border-color: var(--border-glass);
        }
        
        @keyframes fillPop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
            border: 1px solid var(--border-glass);
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-orange);
            border-radius: 4px;
            transition: width 0.8s ease;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }
        
        .progress-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
        
        /* Free Coffee Badge */
        .free-coffee-badge {
            background: var(--gradient-gold);
            color: white;
            padding: 16px 24px;
            border-radius: 24px;
            font-size: 18px;
            font-weight: 700;
            display: inline-block;
            box-shadow: 0 8px 24px rgba(218, 165, 32, 0.4);
            animation: glow 2s infinite alternate;
            margin-bottom: 16px;
        }
        
        @keyframes glow {
            from { 
                box-shadow: 0 8px 24px rgba(218, 165, 32, 0.4);
                transform: scale(1);
            }
            to { 
                box-shadow: 0 12px 32px rgba(218, 165, 32, 0.6), 0 0 20px rgba(218, 165, 32, 0.3);
                transform: scale(1.02);
            }
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .action-btn {
                padding: 16px 12px;
                min-height: 80px;
            }
            
            .action-btn .emoji {
                font-size: 24px;
                margin-bottom: 6px;
            }
        }
        
        .action-btn {
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border-glass);
            border-radius: var(--border-radius);
            padding: 20px 12px;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            box-shadow: var(--shadow-glass);
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }
        
        .action-btn:hover::before {
            left: 100%;
        }
        
        .action-btn:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            background: var(--bg-glass-hover);
        }
        
        .action-btn .emoji {
            display: block;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        /* Footer */
        .footer {
            margin-top: auto;
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            padding: 24px;
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow-glass);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-gold);
        }
        
        .footer-title {
            font-size: 24px;
            font-weight: 800;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        
        .footer-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .barista-info {
            background: var(--bg-input);
            border: 1px solid var(--border-glass);
            border-radius: var(--border-radius-small);
            padding: 12px 16px;
            margin-top: 16px;
            font-size: 13px;
            color: var(--text-muted);
            display: none;
        }
        
        .barista-info.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è */
        .connection-status {
            background: var(--bg-input);
            border: 1px solid var(--border-glass);
            border-radius: var(--border-radius-small);
            padding: 8px 12px;
            margin-top: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .connection-status.online {
            color: var(--accent-green);
            border-color: rgba(0, 212, 170, 0.3);
        }
        
        .connection-status.offline {
            color: var(--accent-red);
            border-color: rgba(255, 71, 87, 0.3);
        }
        
        .connection-status.slow {
            color: var(--accent-yellow);
            border-color: rgba(255, 165, 2, 0.3);
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .connection-status.online .connection-dot {
            background: var(--accent-green);
        }
        
        .connection-status.offline .connection-dot {
            background: var(--accent-red);
        }
        
        .connection-status.slow .connection-dot {
            background: var(--accent-yellow);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            margin: 5% auto;
            padding: 32px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow-hover);
            text-align: center;
        }
        
        .modal-title {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .qr-instructions {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .modal-btn.primary {
            background: var(--gradient-green);
            color: white;
        }
        
        .modal-btn.secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-glass);
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-glass);
            border-top: 3px solid var(--accent-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error State */
        .error-state {
            text-align: center;
            padding: 48px 24px;
            max-width: 400px;
            margin: 0 auto;
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow-glass);
        }
        
        .error-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .error-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        
        .error-message {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 24px;
        }
        
        .error-btn {
            display: inline-block;
            background: var(--gradient-orange);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .error-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255, 107, 53, 0.3);
        }
        
        .error-btn.retry {
            background: var(--gradient-blue);
        }
        
        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 48px 24px;
            max-width: 400px;
            margin: 0 auto;
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow-glass);
        }
        
        .loading-icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .loading-message {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        
        /* Order History Cards - –í–ê–£ –≠–§–§–ï–ö–¢! */
        .history-cards {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 24px 0;
        }
        
        .history-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 24px;
            max-height: calc(90vh - 120px);
        }
        
        .history-cards::-webkit-scrollbar {
            width: 10px;
        }
        
        .history-cards::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 8px;
        }
        
        .history-cards::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--accent-gold), var(--accent-orange));
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(218, 165, 32, 0.3);
        }
        
        .order-card {
            background: linear-gradient(135deg, 
                rgba(26, 26, 46, 0.95) 0%, 
                rgba(22, 33, 62, 0.95) 25%, 
                rgba(15, 52, 96, 0.95) 50%,
                rgba(139, 69, 19, 0.1) 75%,
                rgba(218, 165, 32, 0.1) 100%);
            border-radius: 24px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: cardAppear 0.8s ease-out;
        }
        
        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .order-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(218, 165, 32, 0.3),
                0 0 30px rgba(218, 165, 32, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .order-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                var(--accent-gold) 0%, 
                var(--accent-orange) 50%, 
                var(--accent-gold) 100%);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: -200% 0; }
            50% { background-position: 200% 0; }
        }
        
        .order-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.05) 50%, 
                transparent 70%);
            transform: rotate(45deg);
            animation: holographic 4s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes holographic {
            0%, 100% { transform: rotate(45deg) translateX(-100%); }
            50% { transform: rotate(45deg) translateX(100%); }
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .card-number {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-orange) 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 800;
            box-shadow: 
                0 6px 20px rgba(218, 165, 32, 0.4),
                0 0 20px rgba(218, 165, 32, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .card-number::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: cardNumberShine 2s ease-in-out infinite;
        }
        
        @keyframes cardNumberShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .card-status {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .coffee-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .coffee-slot {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border-glass);
            overflow: hidden;
        }
        
        .coffee-slot.filled {
            background: linear-gradient(135deg, 
                var(--accent-gold) 0%, 
                var(--accent-orange) 50%, 
                var(--accent-gold) 100%);
            border-color: var(--accent-gold);
            color: white;
            box-shadow: 
                0 8px 24px rgba(218, 165, 32, 0.4),
                0 0 20px rgba(218, 165, 32, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: coffeeGlow 3s ease-in-out infinite;
        }
        
        .coffee-slot.filled::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 30px;
            background: linear-gradient(to top, 
                rgba(255, 255, 255, 0.8) 0%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: steam 2s ease-in-out infinite;
            filter: blur(1px);
        }
        
        .coffee-slot.filled::after {
            content: '';
            position: absolute;
            top: -15px;
            left: 45%;
            transform: translateX(-50%);
            width: 15px;
            height: 25px;
            background: linear-gradient(to top, 
                rgba(255, 255, 255, 0.6) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: steam 2s ease-in-out infinite 0.5s;
            filter: blur(1px);
        }
        
        @keyframes steam {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) translateY(-10px) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px) scale(1.2);
            }
        }
        
        .coffee-slot.empty {
            background: var(--bg-input);
            border-color: var(--border-glass);
            color: var(--text-muted);
        }
        
        @keyframes coffeeGlow {
            0%, 100% { 
                box-shadow: 
                    0 8px 24px rgba(218, 165, 32, 0.4),
                    0 0 20px rgba(218, 165, 32, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 
                    0 12px 32px rgba(218, 165, 32, 0.6),
                    0 0 30px rgba(218, 165, 32, 0.5),
                    0 0 10px rgba(255, 255, 255, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }
        
        .coffee-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
            text-align: center;
            line-height: 1.3;
            font-weight: 600;
        }
        
        .coffee-slot.filled .coffee-date {
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-progress {
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-gold), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-brand {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 800;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .no-history {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .no-history-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .no-history-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .no-history-text {
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Large Modal for History */
        .history-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .history-modal-content {
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow-hover);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .history-modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-glass);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .history-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .history-modal-close:hover {
            background: var(--bg-input);
            color: var(--text-primary);
        }
        
        .history-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 24px;
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .container {
                max-width: 500px;
                padding: 40px;
            }
            
            .header {
                padding-top: 60px;
                margin-bottom: 40px;
            }
            
            .customer-name {
                font-size: 42px;
            }
            
            .main-card {
                padding: 40px 32px;
                margin-bottom: 32px;
            }
            
            .coffee-illustration {
                height: 240px;
                margin-bottom: 32px;
                font-size: 80px;
            }
            
            .action-buttons {
                gap: 20px;
                margin-bottom: 40px;
            }
            
            .action-btn {
                padding: 24px 20px;
                font-size: 18px;
                min-height: 120px;
            }
            
            .action-btn .emoji {
                font-size: 32px;
            }
        }
        
        @media (min-width: 1024px) {
            body {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 30px;
            }
            
            .container {
                max-width: 580px;
                min-height: auto;
                background: var(--bg-glass);
                backdrop-filter: var(--blur);
                border-radius: 28px;
                border: 1px solid var(--border-glass);
                box-shadow: var(--shadow-hover);
                padding: 40px 32px;
            }
            
            .customer-name {
                font-size: 28px;
            }
            
            .greeting {
                font-size: 14px;
            }
            
            .current-date {
                font-size: 12px;
            }
            
            .brand-title {
                font-size: 20px;
            }
            
            .brand-subtitle {
                font-size: 13px;
            }
            
            .progress-title {
                font-size: 16px;
            }
            
            .progress-text {
                font-size: 13px;
            }
            
            .coffee-illustration {
                height: 160px;
                font-size: 52px;
            }
            
            .action-btn {
                padding: 14px 12px;
                font-size: 12px;
                min-height: 75px;
            }
            
            .action-btn .emoji {
                font-size: 20px;
                margin-bottom: 6px;
            }
            
            .coffee-dot {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .progress-label {
                font-size: 12px;
            }
            
            .footer-title {
                font-size: 18px;
            }
            
            .footer-subtitle {
                font-size: 12px;
            }
        }
        
        @media (min-width: 1440px) {
            .container {
                max-width: 650px;
                padding: 45px 38px;
            }
            
            .customer-name {
                font-size: 32px;
            }
            
            .greeting {
                font-size: 16px;
            }
            
            .brand-title {
                font-size: 24px;
            }
            
            .progress-title {
                font-size: 18px;
            }
            
            .progress-text {
                font-size: 15px;
            }
            
            .coffee-illustration {
                height: 180px;
                font-size: 60px;
            }
            
            .action-btn {
                padding: 16px 14px;
                font-size: 14px;
                min-height: 85px;
            }
            
            .action-btn .emoji {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            .coffee-dot {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .action-btn {
                padding: 16px 12px;
                min-height: 80px;
            }
            
            .action-btn .emoji {
                font-size: 24px;
                margin-bottom: 6px;
            }
            
            .coffee-dots {
                gap: 8px;
            }
            
            .coffee-dot {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="greeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,</div>
            <div class="customer-name" id="customer-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="current-date" id="current-date"></div>
        </div>

        <div class="main-card">
            <div class="coffee-illustration">‚òï</div>
            
            <div class="brand-section">
                <div class="brand-title">COFFEEMANIA</div>
                <div class="brand-subtitle">–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
            </div>
        </div>

        <div class="progress-section">
            <div class="progress-title">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
            <div class="progress-text" id="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            
            <div class="coffee-dots" id="coffee-dots">
                <!-- Dots will be generated by JavaScript -->
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            
            <div class="progress-label" id="progress-label">0 –∏–∑ 6 –ø–æ–∫—É–ø–æ–∫</div>
            
            <div id="free-coffee-notice" style="display: none; text-align: center; margin-top: 16px;">
                <div class="free-coffee-badge">
                    üéâ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –≥–æ—Ç–æ–≤!
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <a href="#" class="action-btn" onclick="showQR(); return false;">
                <span class="emoji">üì±</span>
                –ú–æ–π QR-–∫–æ–¥
            </a>
            <a href="#" class="action-btn" onclick="showOrderHistory(); return false;">
                <span class="emoji">üìã</span>
                –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤
            </a>
            <a href="#" class="action-btn" onclick="window.open('tel:+77754555570', '_system'); return false;">
                <span class="emoji">üìû</span>
                –ü—Ä–µ–¥–∑–∞–∫–∞–∑
            </a>
        </div>

        <div class="footer">
            <div class="footer-title">COFFEEMANIA</div>
            <div class="footer-subtitle">–í–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
            <div class="barista-info" id="barista-info">
                üë®‚Äçüíº –í–∞—à –±–∞—Ä–∏—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
            </div>
            <div class="connection-status" id="connection-status">
                <div class="connection-dot"></div>
                <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</span>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal" id="qr-modal">
        <div class="modal-content">
            <div class="modal-title">–í–∞—à QR-–∫–æ–¥</div>
            <div class="qr-code">
                <img id="qr-image" src="" alt="QR Code" style="width: 200px; height: 200px;">
            </div>
            <div class="qr-instructions">
                –ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR-–∫–æ–¥ –±–∞—Ä–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="shareCard()">
                    üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                <button class="modal-btn secondary" onclick="hideQR()">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="history-modal" id="history-modal">
        <div class="history-modal-content">
            <div class="history-modal-header">
                <div class="history-modal-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                <button class="history-modal-close" onclick="hideOrderHistory()">&times;</button>
            </div>
            <div class="history-modal-body">
                <div id="history-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï PWA: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ ID –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ PWA –∫–ª–∏–µ–Ω—Ç–∞
        (function() {
            console.log('üîß COFFEEMANIA Client: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ PWA...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –∫–∞–∫ PWA (standalone mode)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIosStandalone = window.navigator.standalone === true;
            const isPWA = isStandalone || isIosStandalone;
            
            if (isPWA) {
                console.log('üì± –ó–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ PWA –∫–ª–∏–µ–Ω—Ç–∞');
                
                // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ URL
                const urlParams = new URLSearchParams(window.location.search);
                const currentClientId = urlParams.get('id');
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID –∏–∑ localStorage
                const savedClientId = localStorage.getItem('coffeemania_customer_id');
                
                console.log('üîç –¢–µ–∫—É—â–∏–π ID –≤ URL:', currentClientId);
                console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID –≤ localStorage:', savedClientId);
                
                // –ï—Å–ª–∏ –Ω–µ—Ç ID –≤ URL, –Ω–æ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL
                if (!currentClientId && savedClientId) {
                    console.log('üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –∫–ª–∏–µ–Ω—Ç–∞');
                    const newUrl = `${window.location.pathname}?id=${savedClientId}`;
                    window.history.replaceState({}, '', newUrl);
                    
                    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º ID
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                    return;
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å ID –≤ URL, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
                if (currentClientId) {
                    localStorage.setItem('coffeemania_customer_id', currentClientId);
                    console.log('üíæ ID –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', currentClientId);
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–≥–æ ID - —ç—Ç–æ –æ—à–∏–±–∫–∞ PWA
                if (!currentClientId && !savedClientId) {
                    console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ PWA –±–µ–∑ ID –∫–ª–∏–µ–Ω—Ç–∞!');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    setTimeout(() => {
                        document.body.innerHTML = `
                            <div style="
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                min-height: 100vh; 
                                text-align: center; 
                                background: var(--bg-primary);
                                color: white;
                                padding: 20px;
                            ">
                                <div style="
                                    background: rgba(255,255,255,0.1);
                                    border-radius: 20px;
                                    padding: 40px;
                                    max-width: 400px;
                                ">
                                    <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                                    <h2 style="margin-bottom: 16px;">–û—à–∏–±–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ PWA</h2>
                                    <p style="margin-bottom: 24px; opacity: 0.8;">
                                        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –£–¥–∞–ª–∏—Ç–µ –µ–≥–æ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –æ—Ç –±–∞—Ä–∏—Å—Ç–∞.
                                    </p>
                                    <button onclick="window.location.href='/'" style="
                                        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
                                        color: white;
                                        border: none;
                                        padding: 12px 24px;
                                        border-radius: 12px;
                                        font-weight: 600;
                                        cursor: pointer;
                                    ">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
                                </div>
                            </div>
                        `;
                    }, 500);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º Service Worker –¥–ª—è –ª—É—á—à–µ–π —Ä–∞–±–æ—Ç—ã
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        return registration.update();
                    }).then(() => {
                        console.log('üîÑ Service Worker –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞');
                    });
                }
            }
        })();
        
        let customerData = null;
        const customerId = new URLSearchParams(window.location.search).get('id');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–ª–∏–µ–Ω—Ç–∞ –≤ localStorage –¥–ª—è PWA
        if (customerId) {
            localStorage.setItem('coffeemania_customer_id', customerId);
            console.log('üíæ ID –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage:', customerId);
        }

        // Set current date
        function setCurrentDate() {
            const now = new Date();
            const options = { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            };
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('ru-RU', options);
        }

        // Load customer data - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∫–∞–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        async function loadCustomerData() {
            if (!customerId) {
                showErrorState();
                return;
            }

            // –ú–ì–ù–û–í–ï–ù–ù–û –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∑–∞–≥–ª—É—à–∫–∞–º–∏
            showLoadingInterface();

            try {
                console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:', customerId);
                
                // –ë–´–°–¢–†–´–ô –∑–∞–ø—Ä–æ—Å —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º
                const response = await fetch(`/api/customer/${customerId}`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000) // –í—Å–µ–≥–æ 3 —Å–µ–∫—É–Ω–¥—ã —Ç–∞–π–º–∞—É—Ç
                });
                
                console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                
                if (!response.ok) {
                    let errorMessage;
                    if (response.status === 404) {
                        errorMessage = `–ö–ª–∏–µ–Ω—Ç —Å ID "${customerId}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å—Å—ã–ª–∫–∏ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∞—Ä–∏—Å—Ç–∞ –∑–∞ –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–æ–π.`;
                    } else if (response.status === 500) {
                        errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∏–µ–Ω—Ç–∞. –ö–æ–¥: ${response.status}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä.`;
                    } else if (response.status === 503) {
                        // –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫–∏
                        console.log('‚è≥ –°–µ—Ä–≤–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫–∏');
                        scheduleRetry();
                        return;
                    } else {
                        errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                customerData = await response.json();
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', customerData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                if (!customerData.id || !customerData.name) {
                    throw new Error('–ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                updateUI();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞:', error);
                
                // –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –∏–ª–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ - –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞—à–Ω—É—é –æ—à–∏–±–∫—É
                if (error.name === 'TimeoutError' || error.name === 'TypeError') {
                    console.log('‚è≥ –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é, –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫–∏ –∏ –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ');
                    scheduleRetry();
                    return;
                }
                
                // –¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                showErrorState(error.message, getTroubleshootingTips(error));
            }
        }
        
        // –ù–û–í–û–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∑–∞–≥–ª—É—à–∫–∞–º–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
        function showLoadingInterface() {
            // –ï—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –µ—â—ë –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
            if (!document.getElementById('customer-name')) {
                restoreCardStructure();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
            const customerNameEl = document.getElementById('customer-name');
            const progressTextEl = document.getElementById('progress-text');
            const freeCoffeeNoticeEl = document.getElementById('free-coffee-notice');
            const coffeeDotsEl = document.getElementById('coffee-dots');
            const progressFillEl = document.getElementById('progress-fill');
            const progressLabelEl = document.getElementById('progress-label');
            
            if (customerNameEl) {
                customerNameEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                customerNameEl.style.opacity = '0.7';
            }
            
            if (progressTextEl) {
                progressTextEl.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
                progressTextEl.style.opacity = '0.7';
            }
            
            if (freeCoffeeNoticeEl) {
                freeCoffeeNoticeEl.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏ –∫–æ—Ñ–µ–π–Ω—ã—Ö —Ç–æ—á–µ–∫
            if (coffeeDotsEl) {
                coffeeDotsEl.innerHTML = '';
                for (let i = 1; i <= 6; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'coffee-dot empty';
                    dot.textContent = '‚òï';
                    dot.style.opacity = '0.4';
                    coffeeDotsEl.appendChild(dot);
                }
            }
            
            if (progressFillEl) {
                progressFillEl.style.width = '0%';
            }
            
            if (progressLabelEl) {
                progressLabelEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
            }
            
            console.log('üéØ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–∫–∞–∑–∞–Ω –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å –∑–∞–≥–ª—É—à–∫–∞–º–∏');
        }
        
        // –ù–û–í–û–ï: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        function scheduleRetry() {
            let retryCount = 0;
            const maxRetries = 3;
            
            const retry = () => {
                retryCount++;
                console.log(`üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${retryCount}/${maxRetries}`);
                
                setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/customer/${customerId}`, {
                            method: 'GET',
                            signal: AbortSignal.timeout(2000)
                        });
                        
                        if (response.ok) {
                            customerData = await response.json();
                            updateUI();
                            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ');
                        } else if (retryCount < maxRetries) {
                            retry();
                        }
                    } catch (error) {
                        if (retryCount < maxRetries) {
                            retry();
                        } else {
                            console.log('‚ö†Ô∏è –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫–∏');
                        }
                    }
                }, retryCount * 2000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É: 2—Å, 4—Å, 6—Å
            };
            
            retry();
        }
        
        // –ù–û–í–û–ï: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –Ω–µ–ø–æ–ª–∞–¥–æ–∫
        function getTroubleshootingTips(error) {
            if (error.message.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö')) {
                return `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(220,53,69,0.1); border-radius: 8px; border-left: 3px solid #dc3545;">
                        <div style="font-weight: 600; margin-bottom: 8px;">‚ùì –ß—Ç–æ –¥–µ–ª–∞—Ç—å:</div>
                        <div style="font-size: 13px; line-height: 1.5;">
                            ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å—Å—ã–ª–∫–∏<br>
                            ‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ, –≤ ID –µ—Å—Ç—å –æ–ø–µ—á–∞—Ç–∫–∞ (0 vs o, l vs I)<br>
                            ‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∞—Ä–∏—Å—Ç–∞ –∑–∞ –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–æ–π<br>
                            ‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ, –∫–ª–∏–µ–Ω—Ç –±—ã–ª –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                        </div>
                    </div>
                `;
            } else if (error.message.includes('500')) {
                return `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(220,53,69,0.1); border-radius: 8px; border-left: 3px solid #dc3545;">
                        <div style="font-weight: 600; margin-bottom: 8px;">üîß –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ:</div>
                        <div style="font-size: 13px; line-height: 1.5;">
                            ‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä (node index.js)<br>
                            ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö<br>
                            ‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã
                        </div>
                    </div>
                `;
            }
            return '';
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º - –ò–°–ü–†–ê–í–õ–ï–ù–û: –ª—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        async function checkConnection() {
            const connectionEl = document.getElementById('connection-status');
            if (!connectionEl) return;
            
            const startTime = Date.now();
            
            try {
                const response = await fetch('/api/stats', {
                    method: 'GET',
                    cache: 'no-cache',
                    signal: AbortSignal.timeout(8000) // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ
                    if (typeof data.totalCustomers === 'number') {
                        updateConnectionStatus('online', responseTime);
                    } else {
                        updateConnectionStatus('slow', responseTime);
                    }
                } else if (response.status === 503) {
                    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞
                    updateConnectionStatus('slow', null);
                } else {
                    updateConnectionStatus('slow', responseTime);
                }
                
            } catch (error) {
                console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:', error.message);
                if (error.name === 'TimeoutError') {
                    updateConnectionStatus('slow', null);
                } else {
                    updateConnectionStatus('offline', null);
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è - –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function updateConnectionStatus(status, responseTime) {
            const connectionEl = document.getElementById('connection-status');
            if (!connectionEl) return;
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã
            connectionEl.className = 'connection-status';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å —Å—Ç–∞—Ç—É—Å–∞
            connectionEl.classList.add(status);
            
            const textEl = connectionEl.querySelector('span');
            
            switch (status) {
                case 'online':
                    textEl.textContent = 'üü¢ –û–Ω–ª–∞–π–Ω';
                    break;
                case 'slow':
                    textEl.textContent = 'üü° –ú–µ–¥–ª–µ–Ω–Ω–æ';
                    break;
                case 'offline':
                    textEl.textContent = 'üî¥ –û—Ñ–ª–∞–π–Ω';
                    break;
            }
        }

        // Restore card structure after loading
        function restoreCardStructure() {
            document.querySelector('.container').innerHTML = `
                <div class="header">
                    <div class="greeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,</div>
                    <div class="customer-name" id="customer-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="current-date" id="current-date"></div>
                </div>

                <div class="main-card">
                    <div class="coffee-illustration">‚òï</div>
                    
                    <div class="brand-section">
                        <div class="brand-title">COFFEEMANIA</div>
                        <div class="brand-subtitle">–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-title">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
                    <div class="progress-text" id="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    
                    <div class="coffee-dots" id="coffee-dots">
                        <!-- Dots will be generated by JavaScript -->
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    
                    <div class="progress-label" id="progress-label">0 –∏–∑ 6 –ø–æ–∫—É–ø–æ–∫</div>
                    
                    <div id="free-coffee-notice" style="display: none; text-align: center; margin-top: 16px;">
                        <div class="free-coffee-badge">
                            üéâ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –≥–æ—Ç–æ–≤!
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <a href="#" class="action-btn" onclick="showQR(); return false;">
                        <span class="emoji">üì±</span>
                        –ú–æ–π QR-–∫–æ–¥
                    </a>
                    <a href="#" class="action-btn" onclick="showOrderHistory(); return false;">
                        <span class="emoji">üìã</span>
                        –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤
                    </a>
                    <a href="#" class="action-btn" onclick="window.open('tel:+77754555570', '_system'); return false;">
                        <span class="emoji">üìû</span>
                        –ü—Ä–µ–¥–∑–∞–∫–∞–∑
                    </a>
                </div>

                <div class="footer">
                    <div class="footer-title">COFFEEMANIA</div>
                    <div class="footer-subtitle">–í–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
                    <div class="barista-info" id="barista-info">
                        üë®‚Äçüíº –í–∞—à –±–∞—Ä–∏—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
                    </div>
                    <div class="connection-status" id="connection-status">
                        <div class="connection-dot"></div>
                        <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</span>
                    </div>
                </div>
            `;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            setCurrentDate();
        }

        // Show error state
        function showErrorState(errorMessage = null, troubleshootingTips = '') {
            const defaultMessage = !customerId ? 
                '–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç –±–∞—Ä–∏—Å—Ç–∞ COFFEEMANIA.' :
                '–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –∏–∑-–∑–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ –≤ —Å–∏—Å—Ç–µ–º–µ.';
                
            document.querySelector('.container').innerHTML = `
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    <div class="error-message">
                        ${errorMessage || defaultMessage}
                        ${customerId ? `<br><br><small style="color: var(--text-muted);">ID –∫–ª–∏–µ–Ω—Ç–∞: ${customerId}</small>` : ''}
                        ${troubleshootingTips}
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="loadCustomerData()" class="error-btn retry" style="margin-right: 12px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                        <a href="/" class="error-btn">üè† –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a>
                    </div>
                </div>
            `;
        }

        // Update UI with customer data - –£–õ–£–ß–®–ï–ù–û: —É–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏
        function updateUI() {
            if (!customerData) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ –Ω–∏–º
            const customerNameEl = document.getElementById('customer-name');
            const progressTextEl = document.getElementById('progress-text');
            const freeCoffeeNoticeEl = document.getElementById('free-coffee-notice');
            const coffeeDotsEl = document.getElementById('coffee-dots');
            const progressFillEl = document.getElementById('progress-fill');
            const progressLabelEl = document.getElementById('progress-label');

            if (!customerNameEl || !progressTextEl || !freeCoffeeNoticeEl || 
                !coffeeDotsEl || !progressFillEl || !progressLabelEl) {
                console.error('‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 200ms...');
                setTimeout(() => updateUI(), 200);
                return;
            }

            // –£–ë–ò–†–ê–ï–ú —ç—Ñ—Ñ–µ–∫—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            customerNameEl.textContent = customerData.name;
            customerNameEl.style.opacity = '1'; // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            
            const currentProgress = customerData.purchases; // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
            const maxPurchases = 6;
            
            // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            let displayPurchases = currentProgress;
            let progressPercent = (currentProgress / maxPurchases) * 100;
            
            // Update progress text —Å —É–±–∏—Ä–∞–Ω–∏–µ–º —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏
            progressTextEl.style.opacity = '1'; // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            if (displayPurchases >= maxPurchases) {
                progressTextEl.textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –≥–æ—Ç–æ–≤';
                freeCoffeeNoticeEl.style.display = 'block';
            } else if (displayPurchases === 0) {
                progressTextEl.textContent = '–ù–∞—á–Ω–∏—Ç–µ —Å–æ–±–∏—Ä–∞—Ç—å –ø–æ–∫—É–ø–∫–∏ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫–æ—Ñ–µ';
                freeCoffeeNoticeEl.style.display = 'none';
            } else {
                const remaining = maxPurchases - displayPurchases;
                progressTextEl.textContent = 
                    `–ï—â–µ ${remaining} –ø–æ–∫—É–ø–æ–∫ –¥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫–æ—Ñ–µ`;
                freeCoffeeNoticeEl.style.display = 'none';
            }
            
            // Update coffee dots –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            coffeeDotsEl.innerHTML = '';
            
            for (let i = 1; i <= maxPurchases; i++) {
                const dot = document.createElement('div');
                dot.className = `coffee-dot ${i <= displayPurchases ? 'filled' : 'empty'}`;
                dot.textContent = '‚òï';
                dot.style.opacity = '1'; // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                dot.style.animation = `fadeIn 0.5s ease ${i * 0.1}s both`;
                
                coffeeDotsEl.appendChild(dot);
            }
            
            // Update progress bar —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            progressFillEl.style.width = `${progressPercent}%`;
            progressFillEl.style.transition = 'width 0.8s ease 0.3s'; // –ê–Ω–∏–º–∞—Ü–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            
            progressLabelEl.textContent = 
                `${displayPurchases} –∏–∑ ${maxPurchases} –ø–æ–∫—É–ø–æ–∫`;
            
            console.log('‚úÖ UI –æ–±–Ω–æ–≤–ª–µ–Ω —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', customerData.name);
        }

        // Initialize - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç
        setCurrentDate();
        
        // –ú–ì–ù–û–í–ï–ù–ù–û –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è
        loadCustomerData();
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(() => {
            checkIfAppInstalled();
        }, 1000);

        // Auto-refresh every 30 seconds - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        setInterval(() => {
            if (customerData) {
                loadCustomerData();
            }
        }, 30000);

        // Show QR modal
        async function showQR() {
            if (!customerId || !customerData) return;
            
            const modal = document.getElementById('qr-modal');
            const qrImage = document.getElementById('qr-image');
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
                modal.style.display = 'flex';
                qrImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvYWRpbmcuLi48L3RleHQ+PC9zdmc+';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º QR-–∫–æ–¥ —á–µ—Ä–µ–∑ API
                const response = await fetch(`/api/qr/${customerId}`);
                const qrData = await response.json();
                
                if (!response.ok) {
                    throw new Error(qrData.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º base64 QR-–∫–æ–¥
                qrImage.src = qrData.qrCode;
                
                console.log('‚úÖ QR-–∫–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR-–∫–æ–¥–∞:', error);
                qrImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZlYmVlIi8+PHRleHQgeD0iNTAlIiB5PSI0NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2RjMzU0NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNTUlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiNkYzM1NDUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUi1rb2Q8L3RleHQ+PC9zdmc+';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –º–æ–¥–∞–ª–µ
                const modalContent = modal.querySelector('.modal-content');
                const instructionsDiv = modalContent.querySelector('.qr-instructions');
                instructionsDiv.innerHTML = `<div style="color: #dc3545; font-size: 14px;">‚ùå ${error.message}</div>`;
            }
        }

        // Hide QR modal
        function hideQR() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        // Click outside modal to close
        document.getElementById('qr-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideQR();
            }
        });

        // Show gift history
        function showGiftHistory() {
            if (!customerId) {
                alert('ID –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const modal = document.getElementById('qr-modal');
            const content = modal.querySelector('.modal-content');
            
            content.innerHTML = `
                <div class="modal-title">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤</div>
                <div style="color: var(--text-primary); margin-bottom: 20px; text-align: left;">
                    <div style="font-size: 16px; margin-bottom: 16px; text-align: center;">üéÅ <strong>–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∫–æ—Ñ–µ</strong></div>
                    <div style="font-size: 14px; line-height: 1.6; background: var(--bg-input); padding: 16px; border-radius: 12px; border: 1px solid var(--border-glass);">
                        <div style="margin-bottom: 12px;">üìä <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong></div>
                        <div style="margin-bottom: 8px;">‚Ä¢ –ö–∞–∂–¥–∞—è –ø–æ–∫—É–ø–∫–∞ –∫–æ—Ñ–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è</div>
                        <div style="margin-bottom: 8px;">‚Ä¢ –ü–æ—Å–ª–µ 6 –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç–µ 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ</div>
                        <div style="margin-bottom: 12px;">‚Ä¢ –ü–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥ –±–∞—Ä–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è</div>
                        
                        <div style="margin-bottom: 8px;">üéØ <strong>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:</strong></div>
                        <div>–ü–æ–∫—É–ø–æ–∫: ${customerData ? customerData.purchases : 0}/6</div>
                        <div>–°—Ç–∞—Ç—É—Å: ${customerData && customerData.purchases >= 6 ? 'üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –≥–æ—Ç–æ–≤!' : '‚òï –°–æ–±–∏—Ä–∞–µ–º –ø–æ–∫—É–ø–∫–∏'}</div>
                    </div>
                </div>
                <button class="modal-btn secondary" onclick="hideQR()" style="width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
            `;
            
            modal.style.display = 'flex';
        }

        // Open preorder options
        async function openPreorder() {
            try {
                let adminPhone = '+77754555570';
                try {
                    const response = await fetch('/api/barista-phone');
                    if (response.ok) {
                        const data = await response.json();
                        adminPhone = data.phone;
                    }
                } catch (error) {
                    console.log('–ò—Å–ø–æ–ª—å–∑—É—é –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –±–∞—Ä–∏—Å—Ç–∞');
                }
                
                const cleanPhone = adminPhone.replace(/\D/g, '');
                
                const modal = document.getElementById('qr-modal');
                const content = modal.querySelector('.modal-content');
                
                content.innerHTML = `
                    <div class="modal-title">–ü—Ä–µ–¥–∑–∞–∫–∞–∑ –∫–æ—Ñ–µ</div>
                    <div style="color: var(--text-primary); margin-bottom: 24px; text-align: left;">
                        <div style="font-size: 16px; margin-bottom: 16px; text-align: center;">üìû <strong>–°–≤—è–∂–∏—Ç–µ—Å—å —Å –±–∞—Ä–∏—Å—Ç–∞</strong></div>
                        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 20px;">
                            –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ –¥–ª—è –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞:
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <a href="https://wa.me/${cleanPhone}?text=–ü—Ä–∏–≤–µ—Ç!%20–•–æ—á—É%20—Å–¥–µ–ª–∞—Ç—å%20–ø—Ä–µ–¥–∑–∞–∫–∞–∑%20–∫–æ—Ñ–µ%20‚òï" 
                               target="_blank" 
                               style="background: var(--gradient-green); color: white; padding: 12px 8px; border-radius: 12px; text-decoration: none; text-align: center; font-weight: 600; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <span style="font-size: 18px;">üí¨</span>
                                WhatsApp
                            </a>
                            <a href="tel:+${cleanPhone}" 
                               style="background: var(--gradient-blue); color: white; padding: 12px 8px; border-radius: 12px; text-decoration: none; text-align: center; font-weight: 600; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <span style="font-size: 18px;">üìû</span>
                                –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                            </a>
                        </div>
                        
                        <div style="font-size: 12px; color: var(--text-muted); text-align: center; margin-bottom: 8px;">
                            –ù–æ–º–µ—Ä –±–∞—Ä–∏—Å—Ç–∞: ${adminPhone}
                        </div>
                    </div>
                    <button class="modal-btn secondary" onclick="hideQR()" style="width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                `;
                
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –±–∞—Ä–∏—Å—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –±–∞—Ä–∏—Å—Ç–∞');
            }
        }

        // Show order history with beautiful bank-style cards - –ò–°–ü–†–ê–í–õ–ï–ù–û –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û
        async function showOrderHistory() {
            if (!customerId) {
                alert('ID –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');
            
            // Show loading
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            `;
            
            modal.style.display = 'flex';
            
            try {
                console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', customerId);
                
                const response = await fetch(`/api/history/${customerId}`);
                console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                }
                
                const history = await response.json();
                console.log('üìä –ü–æ–ª—É—á–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:', history);
                
                if (!Array.isArray(history)) {
                    console.error('‚ùå –ò—Å—Ç–æ—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:', history);
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–∏');
                }
                
                // Generate beautiful order cards
                content.innerHTML = generateOrderCards(history);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                content.innerHTML = `
                    <div class="no-history">
                        <div class="no-history-icon">‚ùå</div>
                        <div class="no-history-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <div class="no-history-text">
                            ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤'}
                            <br><br>
                            <small>ID –∫–ª–∏–µ–Ω—Ç–∞: ${customerId}</small>
                        </div>
                        <button onclick="showOrderHistory()" style="
                            margin-top: 16px; 
                            padding: 8px 16px; 
                            background: var(--gradient-blue); 
                            color: white; 
                            border: none; 
                            border-radius: 8px; 
                            cursor: pointer;
                        ">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
            }
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ò–°–¢–û–†–ò–ò - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
        function generateOrderCards(history) {
            console.log('üî• –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', history);
            console.log('üë§ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:', customerData);
            
            if (!history || history.length === 0) {
                return `
                    <div class="no-history">
                        <div class="no-history-icon">üìã</div>
                        <div class="no-history-title">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
                        <div class="no-history-text">–í–∞—à–∏ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –≤ –≤–∏–¥–µ –∫—Ä–∞—Å–∏–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏.</div>
                    </div>
                `;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–∫—É–ø–∫–∏ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            const purchases = history
                .filter(item => {
                    const isValidPurchase = item && (item.action === 'purchase' || !item.action);
                    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏:', item, '–≤–∞–ª–∏–¥–Ω—ã–π:', isValidPurchase);
                    return isValidPurchase;
                })
                .sort((a, b) => {
                    const dateA = new Date(a.purchase_date || a.timestamp || 0);
                    const dateB = new Date(b.purchase_date || b.timestamp || 0);
                    return dateA - dateB;
                });
            
            console.log('üìä –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏:', purchases);
            
            const cards = [];
            const PURCHASES_PER_CARD = 6;
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–ø–æ 6 –ø–æ–∫—É–ø–æ–∫)
            const completedCardsCount = Math.floor(purchases.length / PURCHASES_PER_CARD);
            
            for (let cardIndex = 0; cardIndex < completedCardsCount; cardIndex++) {
                const startIndex = cardIndex * PURCHASES_PER_CARD;
                const cardPurchases = purchases.slice(startIndex, startIndex + PURCHASES_PER_CARD);
                
                cards.push({
                    number: cardIndex + 1,
                    purchases: cardPurchases,
                    status: 'completed'
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
            const remainingPurchasesInHistory = purchases.length % PURCHASES_PER_CARD;
            const currentProgressFromCustomer = customerData ? customerData.purchases : 0;
            
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏:
            // –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ò–õ–ò —É –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
            if (remainingPurchasesInHistory > 0 || currentProgressFromCustomer > 0) {
                const activePurchases = [];
                
                // –ë–µ—Ä–µ–º –ø–æ–∫—É–ø–∫–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                if (remainingPurchasesInHistory > 0) {
                    const startIndex = completedCardsCount * PURCHASES_PER_CARD;
                    activePurchases.push(...purchases.slice(startIndex));
                }
                
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–æ–ª—å—à–µ —á–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
                const totalNeededPurchases = Math.max(remainingPurchasesInHistory, currentProgressFromCustomer);
                while (activePurchases.length < totalNeededPurchases) {
                    activePurchases.push({
                        purchase_date: new Date().toISOString(),
                        timestamp: new Date().toISOString(),
                        action: 'purchase'
                    });
                }
                
                cards.push({
                    number: completedCardsCount + 1,
                    purchases: activePurchases,
                    status: 'active'
                });
            }
            
            console.log('üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:', cards);
            
            if (cards.length === 0) {
                return `
                    <div class="no-history">
                        <div class="no-history-icon">üìã</div>
                        <div class="no-history-title">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>
                        <div class="no-history-text">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–æ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∞—Ä–∏—Å—Ç–∞.</div>
                    </div>
                `;
            }
            
            return `
                <div class="history-cards">
                    ${cards.map(card => generateSingleCard(card)).join('')}
                </div>
            `;
        }
        
        // Generate single bank-style card
        function generateSingleCard(card) {
            const { number, purchases, status } = card;
            const maxSlots = 6;
            
            return `
                <div class="order-card">
                    <div class="card-header">
                        <div class="card-number">–ö–∞—Ä—Ç–∞ #${number}</div>
                        <div class="card-status">${status === 'completed' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' : '–ê–∫—Ç–∏–≤–Ω–∞—è'}</div>
                    </div>
                    
                    <div class="coffee-grid">
                        ${Array.from({length: maxSlots}, (_, i) => {
                            const purchase = purchases[i];
                            const isFilled = i < purchases.length;
                            
                            return `
                                <div class="coffee-slot ${isFilled ? 'filled' : 'empty'}">
                                    ‚òï
                                    ${isFilled && purchase ? `
                                        <div class="coffee-date">
                                            ${formatDate(purchase.purchase_date)}<br>
                                            ${formatTime(purchase.purchase_date)}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="card-footer">
                        <div class="card-progress">${purchases.length}/6 –ø–æ–∫—É–ø–æ–∫</div>
                        <div class="card-brand">COFFEEMANIA</div>
                    </div>
                </div>
            `;
        }
        
        // Format date for coffee slots
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}.${month}`;
        }
        
        // Format time for coffee slots
        function formatTime(dateString) {
            const date = new Date(dateString);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Hide order history modal
        function hideOrderHistory() {
            document.getElementById('history-modal').style.display = 'none';
        }
        
        // Click outside modal to close
        document.addEventListener('click', function(e) {
            const historyModal = document.getElementById('history-modal');
            if (e.target === historyModal) {
                hideOrderHistory();
            }
        });

        // Share card function
        function shareCard() {
            if (!customerId || !customerData) return;
            
            const cardUrl = `${window.location.origin}/card.html?id=${customerId}`;
            const customerName = customerData.name;
            
            const whatsappMessage = `üéâ –ü—Ä–∏–≤–µ—Ç! –Ø –∏—Å–ø–æ–ª—å–∑—É—é –∫–∞—Ä—Ç—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ COFFEEMANIA ‚òï\n\nüë§ –ö–ª–∏–µ–Ω—Ç: ${customerName}\nüîó –ú–æ—è –∫–∞—Ä—Ç–∞: ${cardUrl}\n\nüíé –ö–∞–∂–¥–∞—è 7-—è —á–∞—à–∫–∞ –∫–æ—Ñ–µ - –ë–ï–°–ü–õ–ê–¢–ù–û!`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // Restore card structure after loading
        function restoreCardStructure() {
            document.querySelector('.container').innerHTML = `
                <div class="header">
                    <div class="greeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,</div>
                    <div class="customer-name" id="customer-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="current-date" id="current-date"></div>
                </div>

                <div class="main-card">
                    <div class="coffee-illustration">‚òï</div>
                    
                    <div class="brand-section">
                        <div class="brand-title">COFFEEMANIA</div>
                        <div class="brand-subtitle">–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-title">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
                    <div class="progress-text" id="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    
                    <div class="coffee-dots" id="coffee-dots">
                        <!-- Dots will be generated by JavaScript -->
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    
                    <div class="progress-label" id="progress-label">0 –∏–∑ 6 –ø–æ–∫—É–ø–æ–∫</div>
                    
                    <div id="free-coffee-notice" style="display: none; text-align: center; margin-top: 16px;">
                        <div class="free-coffee-badge">
                            üéâ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –≥–æ—Ç–æ–≤!
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <a href="#" class="action-btn" onclick="showQR(); return false;">
                        <span class="emoji">üì±</span>
                        –ú–æ–π QR-–∫–æ–¥
                    </a>
                    <a href="#" class="action-btn" onclick="showOrderHistory(); return false;">
                        <span class="emoji">üìã</span>
                        –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤
                    </a>
                    <a href="#" class="action-btn" onclick="window.open('tel:+77754555570', '_system'); return false;">
                        <span class="emoji">üìû</span>
                        –ü—Ä–µ–¥–∑–∞–∫–∞–∑
                    </a>
                </div>

                <div class="footer">
                    <div class="footer-title">COFFEEMANIA</div>
                    <div class="footer-subtitle">–í–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
                    <div class="barista-info" id="barista-info">
                        üë®‚Äçüíº –í–∞—à –±–∞—Ä–∏—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
                    </div>
                    <div class="connection-status" id="connection-status">
                        <div class="connection-dot"></div>
                        <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</span>
                    </div>
                </div>
            `;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            setCurrentDate();
        }

        // Show error state
        function showErrorState(errorMessage = null, troubleshootingTips = '') {
            const defaultMessage = !customerId ? 
                '–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç –±–∞—Ä–∏—Å—Ç–∞ COFFEEMANIA.' :
                '–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –∏–∑-–∑–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ –≤ —Å–∏—Å—Ç–µ–º–µ.';
                
            document.querySelector('.container').innerHTML = `
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    <div class="error-message">
                        ${errorMessage || defaultMessage}
                        ${customerId ? `<br><br><small style="color: var(--text-muted);">ID –∫–ª–∏–µ–Ω—Ç–∞: ${customerId}</small>` : ''}
                        ${troubleshootingTips}
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="loadCustomerData()" class="error-btn retry" style="margin-right: 12px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                        <a href="/" class="error-btn">üè† –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a>
                    </div>
                </div>
            `;
        }

        // Update UI with customer data
        function updateUI() {
            if (!customerData) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ –Ω–∏–º
            const customerNameEl = document.getElementById('customer-name');
            const progressTextEl = document.getElementById('progress-text');
            const freeCoffeeNoticeEl = document.getElementById('free-coffee-notice');
            const coffeeDotsEl = document.getElementById('coffee-dots');
            const progressFillEl = document.getElementById('progress-fill');
            const progressLabelEl = document.getElementById('progress-label');

            if (!customerNameEl || !progressTextEl || !freeCoffeeNoticeEl || 
                !coffeeDotsEl || !progressFillEl || !progressLabelEl) {
                console.error('‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 200ms...');
                setTimeout(() => updateUI(), 200);
                return;
            }

            customerNameEl.textContent = customerData.name;
            
            const currentProgress = customerData.purchases; // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
            const maxPurchases = 6;
            
            // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            let displayPurchases = currentProgress;
            let progressPercent = (currentProgress / maxPurchases) * 100;
            
            // Update progress text
            if (displayPurchases >= maxPurchases) {
                progressTextEl.textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –≥–æ—Ç–æ–≤';
                freeCoffeeNoticeEl.style.display = 'block';
            } else if (displayPurchases === 0) {
                progressTextEl.textContent = '–ù–∞—á–Ω–∏—Ç–µ —Å–æ–±–∏—Ä–∞—Ç—å –ø–æ–∫—É–ø–∫–∏ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫–æ—Ñ–µ';
                freeCoffeeNoticeEl.style.display = 'none';
            } else {
                const remaining = maxPurchases - displayPurchases;
                progressTextEl.textContent = 
                    `–ï—â–µ ${remaining} –ø–æ–∫—É–ø–æ–∫ –¥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫–æ—Ñ–µ`;
                freeCoffeeNoticeEl.style.display = 'none';
            }
            
            // Update coffee dots –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            coffeeDotsEl.innerHTML = '';
            
            for (let i = 1; i <= maxPurchases; i++) {
                const dot = document.createElement('div');
                dot.className = `coffee-dot ${i <= displayPurchases ? 'filled' : 'empty'}`;
                dot.textContent = '‚òï';
                coffeeDotsEl.appendChild(dot);
            }
            
            // Update progress bar
            progressFillEl.style.width = `${progressPercent}%`;
            progressLabelEl.textContent = 
                `${displayPurchases} –∏–∑ ${maxPurchases} –ø–æ–∫—É–ø–æ–∫`;
            
            console.log('‚úÖ UI –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', customerData.name);
        }

        // Show QR modal
        async function showQR() {
            if (!customerId || !customerData) return;
            
            const modal = document.getElementById('qr-modal');
            const qrImage = document.getElementById('qr-image');
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
                modal.style.display = 'flex';
                qrImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvYWRpbmcuLi48L3RleHQ+PC9zdmc+';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º QR-–∫–æ–¥ —á–µ—Ä–µ–∑ API
                const response = await fetch(`/api/qr/${customerId}`);
                const qrData = await response.json();
                
                if (!response.ok) {
                    throw new Error(qrData.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º base64 QR-–∫–æ–¥
                qrImage.src = qrData.qrCode;
                
                console.log('‚úÖ QR-–∫–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR-–∫–æ–¥–∞:', error);
                qrImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZlYmVlIi8+PHRleHQgeD0iNTAlIiB5PSI0NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2RjMzU0NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNTUlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiNkYzM1NDUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUi1rb2Q8L3RleHQ+PC9zdmc+';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –º–æ–¥–∞–ª–µ
                const modalContent = modal.querySelector('.modal-content');
                const instructionsDiv = modalContent.querySelector('.qr-instructions');
                instructionsDiv.innerHTML = `<div style="color: #dc3545; font-size: 14px;">‚ùå ${error.message}</div>`;
            }
        }

        // Hide QR modal
        function hideQR() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        // Click outside modal to close
        document.getElementById('qr-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideQR();
            }
        });

        // Show gift history
        function showGiftHistory() {
            if (!customerId) {
                alert('ID –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const modal = document.getElementById('qr-modal');
            const content = modal.querySelector('.modal-content');
            
            content.innerHTML = `
                <div class="modal-title">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤</div>
                <div style="color: var(--text-primary); margin-bottom: 20px; text-align: left;">
                    <div style="font-size: 16px; margin-bottom: 16px; text-align: center;">üéÅ <strong>–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∫–æ—Ñ–µ</strong></div>
                    <div style="font-size: 14px; line-height: 1.6; background: var(--bg-input); padding: 16px; border-radius: 12px; border: 1px solid var(--border-glass);">
                        <div style="margin-bottom: 12px;">üìä <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong></div>
                        <div style="margin-bottom: 8px;">‚Ä¢ –ö–∞–∂–¥–∞—è –ø–æ–∫—É–ø–∫–∞ –∫–æ—Ñ–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è</div>
                        <div style="margin-bottom: 8px;">‚Ä¢ –ü–æ—Å–ª–µ 6 –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç–µ 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ</div>
                        <div style="margin-bottom: 12px;">‚Ä¢ –ü–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥ –±–∞—Ä–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è</div>
                        
                        <div style="margin-bottom: 8px;">üéØ <strong>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:</strong></div>
                        <div>–ü–æ–∫—É–ø–æ–∫: ${customerData ? customerData.purchases : 0}/6</div>
                        <div>–°—Ç–∞—Ç—É—Å: ${customerData && customerData.purchases >= 6 ? 'üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –≥–æ—Ç–æ–≤!' : '‚òï –°–æ–±–∏—Ä–∞–µ–º –ø–æ–∫—É–ø–∫–∏'}</div>
                    </div>
                </div>
                <button class="modal-btn secondary" onclick="hideQR()" style="width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
            `;
            
            modal.style.display = 'flex';
        }

        // Open preorder options
        async function openPreorder() {
            try {
                let adminPhone = '+77754555570';
                try {
                    const response = await fetch('/api/barista-phone');
                    if (response.ok) {
                        const data = await response.json();
                        adminPhone = data.phone;
                    }
                } catch (error) {
                    console.log('–ò—Å–ø–æ–ª—å–∑—É—é –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –±–∞—Ä–∏—Å—Ç–∞');
                }
                
                const cleanPhone = adminPhone.replace(/\D/g, '');
                
                const modal = document.getElementById('qr-modal');
                const content = modal.querySelector('.modal-content');
                
                content.innerHTML = `
                    <div class="modal-title">–ü—Ä–µ–¥–∑–∞–∫–∞–∑ –∫–æ—Ñ–µ</div>
                    <div style="color: var(--text-primary); margin-bottom: 24px; text-align: left;">
                        <div style="font-size: 16px; margin-bottom: 16px; text-align: center;">üìû <strong>–°–≤—è–∂–∏—Ç–µ—Å—å —Å –±–∞—Ä–∏—Å—Ç–∞</strong></div>
                        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 20px;">
                            –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ –¥–ª—è –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞:
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <a href="https://wa.me/${cleanPhone}?text=–ü—Ä–∏–≤–µ—Ç!%20–•–æ—á—É%20—Å–¥–µ–ª–∞—Ç—å%20–ø—Ä–µ–¥–∑–∞–∫–∞–∑%20–∫–æ—Ñ–µ%20‚òï" 
                               target="_blank" 
                               style="background: var(--gradient-green); color: white; padding: 12px 8px; border-radius: 12px; text-decoration: none; text-align: center; font-weight: 600; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <span style="font-size: 18px;">üí¨</span>
                                WhatsApp
                            </a>
                            <a href="tel:+${cleanPhone}" 
                               style="background: var(--gradient-blue); color: white; padding: 12px 8px; border-radius: 12px; text-decoration: none; text-align: center; font-weight: 600; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <span style="font-size: 18px;">üìû</span>
                                –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                            </a>
                        </div>
                        
                        <div style="font-size: 12px; color: var(--text-muted); text-align: center; margin-bottom: 8px;">
                            –ù–æ–º–µ—Ä –±–∞—Ä–∏—Å—Ç–∞: ${adminPhone}
                        </div>
                    </div>
                    <button class="modal-btn secondary" onclick="hideQR()" style="width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                `;
                
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –±–∞—Ä–∏—Å—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –±–∞—Ä–∏—Å—Ç–∞');
            }
        }

        // Show order history with beautiful bank-style cards - –ò–°–ü–†–ê–í–õ–ï–ù–û –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û
        async function showOrderHistory() {
            if (!customerId) {
                alert('ID –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');
            
            // Show loading
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            `;
            
            modal.style.display = 'flex';
            
            try {
                console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', customerId);
                
                const response = await fetch(`/api/history/${customerId}`);
                console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                }
                
                const history = await response.json();
                console.log('üìä –ü–æ–ª—É—á–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:', history);
                
                if (!Array.isArray(history)) {
                    console.error('‚ùå –ò—Å—Ç–æ—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:', history);
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–∏');
                }
                
                // Generate beautiful order cards
                content.innerHTML = generateOrderCards(history);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                content.innerHTML = `
                    <div class="no-history">
                        <div class="no-history-icon">‚ùå</div>
                        <div class="no-history-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <div class="no-history-text">
                            ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤'}
                            <br><br>
                            <small>ID –∫–ª–∏–µ–Ω—Ç–∞: ${customerId}</small>
                        </div>
                        <button onclick="showOrderHistory()" style="
                            margin-top: 16px; 
                            padding: 8px 16px; 
                            background: var(--gradient-blue); 
                            color: white; 
                            border: none; 
                            border-radius: 8px; 
                            cursor: pointer;
                        ">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
            }
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ò–°–¢–û–†–ò–ò - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
        function generateOrderCards(history) {
            console.log('üî• –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', history);
            console.log('üë§ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:', customerData);
            
            if (!history || history.length === 0) {
                return `
                    <div class="no-history">
                        <div class="no-history-icon">üìã</div>
                        <div class="no-history-title">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
                        <div class="no-history-text">–í–∞—à–∏ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –≤ –≤–∏–¥–µ –∫—Ä–∞—Å–∏–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏.</div>
                    </div>
                `;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–∫—É–ø–∫–∏ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            const purchases = history
                .filter(item => {
                    const isValidPurchase = item && (item.action === 'purchase' || !item.action);
                    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏:', item, '–≤–∞–ª–∏–¥–Ω—ã–π:', isValidPurchase);
                    return isValidPurchase;
                })
                .sort((a, b) => {
                    const dateA = new Date(a.purchase_date || a.timestamp || 0);
                    const dateB = new Date(b.purchase_date || b.timestamp || 0);
                    return dateA - dateB;
                });
            
            console.log('üìä –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏:', purchases);
            
            const cards = [];
            const PURCHASES_PER_CARD = 6;
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–ø–æ 6 –ø–æ–∫—É–ø–æ–∫)
            const completedCardsCount = Math.floor(purchases.length / PURCHASES_PER_CARD);
            
            for (let cardIndex = 0; cardIndex < completedCardsCount; cardIndex++) {
                const startIndex = cardIndex * PURCHASES_PER_CARD;
                const cardPurchases = purchases.slice(startIndex, startIndex + PURCHASES_PER_CARD);
                
                cards.push({
                    number: cardIndex + 1,
                    purchases: cardPurchases,
                    status: 'completed'
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
            const remainingPurchasesInHistory = purchases.length % PURCHASES_PER_CARD;
            const currentProgressFromCustomer = customerData ? customerData.purchases : 0;
            
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏:
            // –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ò–õ–ò —É –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
            if (remainingPurchasesInHistory > 0 || currentProgressFromCustomer > 0) {
                const activePurchases = [];
                
                // –ë–µ—Ä–µ–º –ø–æ–∫—É–ø–∫–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                if (remainingPurchasesInHistory > 0) {
                    const startIndex = completedCardsCount * PURCHASES_PER_CARD;
                    activePurchases.push(...purchases.slice(startIndex));
                }
                
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–æ–ª—å—à–µ —á–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
                const totalNeededPurchases = Math.max(remainingPurchasesInHistory, currentProgressFromCustomer);
                while (activePurchases.length < totalNeededPurchases) {
                    activePurchases.push({
                        purchase_date: new Date().toISOString(),
                        timestamp: new Date().toISOString(),
                        action: 'purchase'
                    });
                }
                
                cards.push({
                    number: completedCardsCount + 1,
                    purchases: activePurchases,
                    status: 'active'
                });
            }
            
            console.log('üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:', cards);
            
            if (cards.length === 0) {
                return `
                    <div class="no-history">
                        <div class="no-history-icon">üìã</div>
                        <div class="no-history-title">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>
                        <div class="no-history-text">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–æ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∞—Ä–∏—Å—Ç–∞.</div>
                    </div>
                `;
            }
            
            return `
                <div class="history-cards">
                    ${cards.map(card => generateSingleCard(card)).join('')}
                </div>
            `;
        }
        
        // Generate single bank-style card
        function generateSingleCard(card) {
            const { number, purchases, status } = card;
            const maxSlots = 6;
            
            return `
                <div class="order-card">
                    <div class="card-header">
                        <div class="card-number">–ö–∞—Ä—Ç–∞ #${number}</div>
                        <div class="card-status">${status === 'completed' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' : '–ê–∫—Ç–∏–≤–Ω–∞—è'}</div>
                    </div>
                    
                    <div class="coffee-grid">
                        ${Array.from({length: maxSlots}, (_, i) => {
                            const purchase = purchases[i];
                            const isFilled = i < purchases.length;
                            
                            return `
                                <div class="coffee-slot ${isFilled ? 'filled' : 'empty'}">
                                    ‚òï
                                    ${isFilled && purchase ? `
                                        <div class="coffee-date">
                                            ${formatDate(purchase.purchase_date)}<br>
                                            ${formatTime(purchase.purchase_date)}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="card-footer">
                        <div class="card-progress">${purchases.length}/6 –ø–æ–∫—É–ø–æ–∫</div>
                        <div class="card-brand">COFFEEMANIA</div>
                    </div>
                </div>
            `;
        }
        
        // Format date for coffee slots
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}.${month}`;
        }
        
        // Format time for coffee slots
        function formatTime(dateString) {
            const date = new Date(dateString);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Hide order history modal
        function hideOrderHistory() {
            document.getElementById('history-modal').style.display = 'none';
        }
        
        // Click outside modal to close
        document.addEventListener('click', function(e) {
            const historyModal = document.getElementById('history-modal');
            if (e.target === historyModal) {
                hideOrderHistory();
            }
        });

        // Share card function
        function shareCard() {
            if (!customerId || !customerData) return;
            
            const cardUrl = `${window.location.origin}/card.html?id=${customerId}`;
            const customerName = customerData.name;
            
            const whatsappMessage = `üéâ –ü—Ä–∏–≤–µ—Ç! –Ø –∏—Å–ø–æ–ª—å–∑—É—é –∫–∞—Ä—Ç—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ COFFEEMANIA ‚òï\n\nüë§ –ö–ª–∏–µ–Ω—Ç: ${customerName}\nüîó –ú–æ—è –∫–∞—Ä—Ç–∞: ${cardUrl}\n\nüíé –ö–∞–∂–¥–∞—è 7-—è —á–∞—à–∫–∞ –∫–æ—Ñ–µ - –ë–ï–°–ü–õ–ê–¢–ù–û!`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // Initialize
        setCurrentDate();
        loadCustomerData();
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(() => {
            checkIfAppInstalled();
        }, 1000);

        // Auto-refresh every 30 seconds
        setInterval(loadCustomerData, 30000);
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('COFFEEMANIA SW registered: ', registration);
                })
                .catch((registrationError) => {
                    console.log('COFFEEMANIA SW registration failed: ', registrationError);
                });
            });
        }
        
        // PWA Install prompt for client app
        let clientDeferredPrompt;
        let isAppInstalled = false;
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        function checkIfAppInstalled() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º display mode PWA
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIosStandalone = window.navigator.standalone === true;
            
            isAppInstalled = isStandalone || isIosStandalone;
            console.log('üì± PWA —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏:', isAppInstalled ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ' : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            
            if (isAppInstalled) {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                const installBtn = document.getElementById('install-btn');
                const installSection = document.getElementById('pwa-install-section');
                
                if (installBtn) installBtn.style.display = 'none';
                if (installSection) installSection.style.display = 'none';
                
                console.log('üì± –ö–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫—Ä—ã—Ç—ã - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            } else {
                // –ù–û–í–û–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                showInstallButton();
            }
            
            return isAppInstalled;
        }
        
        // –£–õ–£–ß–®–ï–ù–û: –ë–æ–ª–µ–µ —É–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function showInstallButton() {
            if (isAppInstalled) {
                console.log('üì± PWA —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ - –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞');
                return;
            }
            
            const installBtn = document.getElementById('install-btn');
            const installSection = document.getElementById('pwa-install-section');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            console.log('üì± –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', {
                mobile: isMobile,
                iOS: isIOS,
                android: isAndroid,
                desktop: !isMobile
            });
            
            // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
            if (installBtn) {
                installBtn.style.display = 'block';
                console.log('üì± –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA –ø–æ–∫–∞–∑–∞–Ω–∞ –≤ action-buttons');
            }
            
            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
            if (isMobile && installSection) {
                if (isIOS) {
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è iOS
                    installSection.innerHTML = `
                        <div class="glass-card" style="margin-top: 24px; padding: 20px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                üçé –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ iPhone/iPad
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; margin-bottom: 16px;">
                                <div style="background: var(--bg-input); padding: 12px; border-radius: 8px; margin: 8px 0; border: 1px solid var(--border-glass);">
                                    <strong>1.</strong> –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" <span style="font-size: 1.2rem;">‚§¥Ô∏è</span>
                                </div>
                                <div style="background: var(--bg-input); padding: 12px; border-radius: 8px; margin: 8px 0; border: 1px solid var(--border-glass);">
                                    <strong>2.</strong> –í—ã–±–µ—Ä–∏—Ç–µ "–ù–∞ —ç–∫—Ä–∞–Ω '–î–æ–º–æ–π'" üè†
                                </div>
                                <div style="background: var(--bg-input); padding: 12px; border-radius: 8px; margin: 8px 0; border: 1px solid var(--border-glass);">
                                    <strong>3.</strong> –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å" ‚ûï
                                </div>
                            </div>
                            <div style="background: rgba(0,122,255,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,122,255,0.3);">
                                <span style="font-size: 1.2rem;">üí°</span> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
                            </div>
                        </div>
                    `;
                } else if (isAndroid) {
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Android
                    installSection.innerHTML = `
                        <div class="glass-card" style="margin-top: 24px; padding: 20px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                ü§ñ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ Android
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; margin-bottom: 16px;">
                                <div style="background: var(--bg-input); padding: 12px; border-radius: 8px; margin: 8px 0; border: 1px solid var(--border-glass);">
                                    <strong>Chrome:</strong> –ü–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
                                </div>
                                <div style="background: var(--bg-input); padding: 12px; border-radius: 8px; margin: 8px 0; border: 1px solid var(--border-glass);">
                                    <strong>–î—Ä—É–≥–∏–µ –±—Ä–∞—É–∑–µ—Ä—ã:</strong> –ú–µ–Ω—é ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω"
                                </div>
                            </div>
                            <div style="background: rgba(76,175,80,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(76,175,80,0.3);">
                                <span style="font-size: 1.2rem;">üöÄ</span> –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–π –∫–∞—Ä—Ç–µ!
                            </div>
                        </div>
                    `;
                } else {
                    // –û–±—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    installSection.innerHTML = `
                        <div class="glass-card" style="margin-top: 24px; padding: 20px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; margin-bottom: 16px;">
                                –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –≤—ã—à–µ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –æ–ø—Ü–∏—é "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω" –≤ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞
                            </div>
                            <div style="background: rgba(255,107,53,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,107,53,0.3);">
                                <span style="font-size: 1.2rem;">‚òï</span> –í–∞—à–∞ –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π!
                            </div>
                        </div>
                    `;
                }
                
                installSection.style.display = 'block';
                console.log('üì± –°–µ–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA –ø–æ–∫–∞–∑–∞–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
        
        // –£–õ–£–ß–®–ï–ù–û: –õ—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            clientDeferredPrompt = e;
            console.log('üì± COFFEEMANIA: Install prompt –¥–æ—Å—Ç—É–ø–µ–Ω');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (!checkIfAppInstalled()) {
                showInstallButton();
            }
        });
        
        // –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA
        window.addEventListener('appinstalled', () => {
            console.log('üéâ COFFEEMANIA PWA —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
            isAppInstalled = true;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            const installBtn = document.getElementById('install-btn');
            const installSection = document.getElementById('pwa-install-section');
            
            if (installBtn) installBtn.style.display = 'none';
            if (installSection) installSection.style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            setTimeout(() => {
                alert('üéâ COFFEEMANIA —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä—è–º–æ —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞.');
            }, 1000);
        });
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA –∫–ª–∏–µ–Ω—Ç–∞ - —É–¥–∞–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
    </script>
        <script src="/connection-check.js"></script>

    <script>
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è PWA
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('id');
        
        if (clientId) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            document.getElementById('manifest-link').href = `/manifest-${clientId}.json`;
            console.log(`üì± PWA –±—É–¥–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞: ${clientId}`);
        } else {
            // Fallback –Ω–∞ –æ–±—â–∏–π –º–∞–Ω–∏—Ñ–µ—Å—Ç
            document.getElementById('manifest-link').href = '/manifest.json';
        }
    </script>

    <!-- Legacy function for compatibility -->
    <script>
        // PWA —Ñ—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
    </script>

</body>
</html>
